<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>İşaret Dili Modeli</title>
    <style>
  #videoElement {
    transform: scaleX(-1);
  }
</style>

<video id="videoElement" autoplay playsinline></video>
</head>
<body>

<h1>İşaret Dili Modeli</h1>

<!-- Canlı Kamera -->
<h2>Canlı Kamera ile İşaret Dili Tanıma</h2>
<video id="video" autoplay playsinline width="320" height="240"></video>
<p>Tanımlanan: <span id="prediction">Bekleniyor...</span></p>

<!-- Yazıdan İşaret Diline -->
<hr>
<h2>Yazıyı İşaret Diline Çevir (Video)</h2>
<textarea id="textInput" rows="3" cols="40" placeholder="Yazınızı buraya girin"></textarea><br />
<button id="convertTextBtn">Video Oluştur</button><br />
<video id="signVideo" width="320" height="240" controls></video>

<!-- Ses → Yazı -->
<hr>
<h2>Sesle Yazıya Çeviri</h2>
<input type="file" id="audioInput" accept="audio/*" />
<button id="speechToTextBtn">Ses → Yazı</button>
<p>Sonuç: <span id="speechTextResult"></span></p>

<!-- Yazıyı Sese Çevir -->
<hr>
<h2>Yazıyı Sese Çevir</h2>
<button id="textToSpeechBtn">Yazıyı Sesle Oku</button>
<audio id="ttsAudio" controls></audio>

<script>
  // Kamera ayarları
  const video = document.getElementById("video");
  const predictionSpan = document.getElementById("prediction");

  navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
    video.srcObject = stream;
  });

  // Kamera görüntüsünü periyodik gönderme
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  async function sendFrame() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    let dataUrl = canvas.toDataURL("image/jpeg");

    let res = await fetch("/predict_sign", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ image: dataUrl }),
    });
    let data = await res.json();
    predictionSpan.textContent = data.text || "Tanımlanamadı";

    setTimeout(sendFrame, 1000); // 1 saniyede bir tahmin
  }

  video.onloadeddata = () => {
    sendFrame();
  };

  // Yazıdan İşaret Diline video oluşturma
  const convertTextBtn = document.getElementById("convertTextBtn");
  const signVideo = document.getElementById("signVideo");
  const textInput = document.getElementById("textInput");

  convertTextBtn.addEventListener("click", async () => {
    const text = textInput.value.trim();
    if (!text) {
      alert("Lütfen yazı girin");
      return;
    }

    let res = await fetch("/text_to_sign", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text }),
    });
    let data = await res.json();
    if (data.error) {
      alert("Hata: " + data.error);
      return;
    }
    signVideo.src = data.video_path + "?t=" + new Date().getTime();
    signVideo.play();
  });

  // Ses → Yazı
  const audioInput = document.getElementById("audioInput");
  const speechToTextBtn = document.getElementById("speechToTextBtn");
  const speechTextResult = document.getElementById("speechTextResult");

  speechToTextBtn.addEventListener("click", async () => {
    if (!audioInput.files.length) {
      alert("Lütfen ses dosyası seçin.");
      return;
    }

    const formData = new FormData();
    formData.append("audio", audioInput.files[0]);

    let res = await fetch("/speech_to_text", {
      method: "POST",
      body: formData,
    });
    let data = await res.json();
    if (data.error) {
      alert("Hata: " + data.error);
    } else {
      speechTextResult.textContent = data.text;
    }
  });

  // Yazıyı Sese Çevir
  const textToSpeechBtn = document.getElementById("textToSpeechBtn");
  const ttsAudio = document.getElementById("ttsAudio");

  textToSpeechBtn.addEventListener("click", async () => {
    const text = textInput.value.trim();
    if (!text) {
      alert("Lütfen yazı girin.");
      return;
    }

    let res = await fetch("/text_to_speech", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text }),
    });

    if (!res.ok) {
      const err = await res.json();
      alert("Hata: " + (err.error || "Bilinmeyen"));
      return;
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    ttsAudio.src = url;
    ttsAudio.play();
  });
</script>

</body>
</html>
